name: PR Validation

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Zola
        uses: taiki-e/install-action@v2
        with:
          tool: zola@0.19.2

      - name: Check Zola version
        run: zola --version

      - name: Build site
        run: zola build

      - name: Check build output
        run: |
          if [ ! -d "public" ]; then
            echo "Error: Build did not produce public directory"
            exit 1
          fi
          if [ ! -f "public/index.html" ]; then
            echo "Error: index.html not found in build output"
            exit 1
          fi
          echo "✓ Build successful"
          echo "Build output size: $(du -sh public | cut -f1)"
          echo "Number of HTML files: $(find public -name '*.html' | wc -l)"

      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links..."
          cd public
          # Find all HTML files and check for broken internal links
          find . -name "*.html" -type f | while read -r file; do
            echo "Checking $file"
            grep -oP 'href="(/[^"#]*)"' "$file" | sed 's/href="//;s/"$//' | while read -r link; do
              # Remove trailing slash for comparison
              clean_link=$(echo "$link" | sed 's:/$::')
              # Check if the file exists (handling both file.html and directory/index.html cases)
              if [ ! -f ".${clean_link}" ] && [ ! -f ".${clean_link}.html" ] && [ ! -f ".${clean_link}/index.html" ]; then
                echo "⚠️  Broken link found in $file: $link"
              fi
            done
          done

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-${{ github.event.pull_request.number }}
          path: public/
          retention-days: 7

      - name: Comment PR with build status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Count HTML files
            const countFiles = (dir, ext) => {
              let count = 0;
              const files = fs.readdirSync(dir, { withFileTypes: true });
              for (const file of files) {
                if (file.isDirectory()) {
                  count += countFiles(path.join(dir, file.name), ext);
                } else if (file.name.endsWith(ext)) {
                  count++;
                }
              }
              return count;
            };

            const htmlCount = countFiles('public', '.html');

            const message = `## ✅ Build Validation Passed

            The site was successfully built and validated.

            **Build Statistics:**
            - HTML pages generated: ${htmlCount}
            - Build artifact uploaded for review

            You can download the build artifact from the Actions tab to review the generated site locally.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
